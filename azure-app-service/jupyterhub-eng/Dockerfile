from jupyterhub/jupyterhub:5.2.1

COPY secret.sh /tmp/secret.sh
COPY requirements.txt .

RUN mkdir /etc/jupyterhub && \
  python3 -m pip install --upgrade jupyterlab && \
  python3 -m pip install --no-cache-dir --upgrade pip setuptools && \
  python3 -m pip install --no-cache-dir -r requirements.txt

RUN apt-get update && \
    apt-get install --yes --no-install-recommends \
        git-all \
        unzip

COPY jupyterhub_config.py /etc/jupyterhub/jupyterhub_config.py
# Note that the users are generated by secret.sh, and reference a GH action secret for the list of credentials.
RUN --mount=type=secret,id=USER_CREDS_ENG /tmp/secret.sh "$(cat /run/secrets/USER_CREDS_ENG)"

CMD ["jupyterhub", "-f", "/etc/jupyterhub/jupyterhub_config.py"]
